# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with the API application.

## Overview

Hono API deployed on Cloudflare Workers with OpenAPI support, Drizzle ORM, and Better Auth.

## Commands

```sh
# Development
pnpm dev                  # Start API dev server (http://localhost:8787)
pnpm test                 # Run tests with Vitest + Cloudflare Workers pool
pnpm build                # Build with Wrangler

# Database
pnpm db:push              # Apply migrations to Turso
pnpm db:generate          # Generate new migrations from schema
pnpm generate-auth-schema # Generate Better Auth schema

# Quality
pnpm typecheck            # Type check with TypeScript
pnpm lint                 # Lint with ESLint
```

## Architecture

### Middleware Pattern

Middleware order is critical - dependencies must be attached before use:

```typescript
const app = createRouter()
  .use(validateAndAttachEnv)     // Environment validation (first)
  .use(requestId())              // Request ID before logging
  .use(pinoLogger())             // Logging early
  .use(cors({ origin: trustedOrigins }))
  .use(csrf({ origin: trustedOrigins }))
  .use(attachDb)                 // Database connection
  .use(attachEmailer)            // Email service
  .use(attachAuthEntities);      // Auth (depends on db + emailer)
```

### Route Organization

Routes follow a feature-based pattern:

```
src/routes/
├── index.ts               # Route registration + router type export
├── index.route.ts         # Root route handlers
└── tasks/
    ├── tasks.index.ts     # Task route exports
    ├── tasks.routes.ts    # OpenAPI route definitions
    ├── tasks.handlers.ts  # Route handler implementations
    └── tasks.test.ts      # Vitest tests
```

**Critical**: The standalone `router` type exported from `src/routes/index.ts` is used by the API client for type inference.

### OpenAPI Integration

All routes must include OpenAPI specifications:

```typescript
export const list = createRoute({
  method: "get",
  path: "/tasks",
  tags: ["tasks"],
  summary: "Get all tasks",
  responses: {
    [HttpStatusCodes.OK]: {
      content: { "application/json": { schema: z.array(selectTasksSchema) } },
      description: "List of tasks",
    },
  },
});
```

## Database Patterns

### Schema Organization

```
src/db/
├── schema.ts          # Main schema export (re-exports all)
├── auth.schema.ts     # Generated by better-auth CLI (do not edit)
├── tasks.schema.ts    # Feature-specific schemas
└── migrations/        # Generated migration files
```

### Table Definitions

```typescript
export const tasks = sqliteTable("tasks", {
  id: integer({ mode: "number" }).primaryKey({ autoIncrement: true }),
  name: text().notNull(),
  done: integer({ mode: "boolean" }).notNull().default(false),
  createdBy: text().references(() => users.id, { onDelete: "cascade" }).notNull(),
  createdAt: integer({ mode: "timestamp" }).notNull().$defaultFn(() => new Date()),
  updatedAt: integer({ mode: "timestamp" }).notNull().$defaultFn(() => new Date()).$onUpdate(() => new Date()),
});
```

### Validation Schemas

Always generate Zod schemas from Drizzle schemas:

```typescript
export const insertTasksSchema = createInsertSchema(tasks, {
  name: schema => schema.min(1).max(500),
}).required({
  done: true,
}).omit({
  id: true,
  createdBy: true,
  createdAt: true,
  updatedAt: true,
});

export const selectTasksSchema = createSelectSchema(tasks);
```

## Authentication

Better Auth is configured in `src/lib/auth.ts` (not `better-auth.config.ts`):

- Role-based access control (user, editor, admin)
- Email/password with verification
- Admin plugin with permissions
- Expo plugin for mobile

The `better-auth.config.ts` file exists only for the CLI command `generate-auth-schema`.

### Route Protection

```typescript
export const protectedHandler: AppRouteHandler<ProtectedRoute> = async (c) => {
  const user = c.get("user");

  if (!user) {
    return c.json({ error: "Unauthorized" }, 401);
  }

  if (!hasRole(user, "admin")) {
    return c.json({ error: "Forbidden" }, 403);
  }

  // Handler logic...
};
```

## Testing

Use createTestApp for isolated route testing:

```typescript
const app = createTestApp(tasksRouter);

it("should create a new task", async () => {
  const response = await app.request("/tasks", {
    method: "POST",
    body: JSON.stringify({ name: "Test Task" }),
  });

  expect(response.status).toBe(201);
});
```

## Best Practices

- Use typed route handlers: `AppRouteHandler<RouteType>`
- Extract context dependencies at start: `const db = c.get("db")`
- Use proper HTTP status codes from `stoker/http-status-codes`
- Always validate input with Zod schemas
- Never access `process.env` directly - use validated env from context
- Use snake_case for database columns (configured in Drizzle)
- Never edit auth.schema.ts manually - regenerate with CLI
- Use `cross-env ENVIRONMENT=test` for testing
